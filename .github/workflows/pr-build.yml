name: PR Build - Test App Build

on:
  pull_request:
    branches:
      - main
    paths:
      - 'SOCKS5Server/**'
      - '.github/workflows/pr-build.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  build:
    name: Build and Test PR
    runs-on: macos-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout PR Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Get App Version
        run: |
          cd SOCKS5Server
          APP_VERSION=$(xcodebuild -project SOCKS5Server.xcodeproj -showBuildSettings 2>/dev/null | grep 'MARKETING_VERSION' | head -1 | awk '{print $NF}')
          if [ -z "$APP_VERSION" ]; then
            APP_VERSION="1.0"
          fi
          echo "APP_VERSION=$APP_VERSION" >> $GITHUB_ENV
          echo "BUILD_NUMBER=PR-${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV

      - name: Build iOS App
        run: |
          cd SOCKS5Server
          xcodebuild -project SOCKS5Server.xcodeproj \
            -scheme SOCKS5Server \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -archivePath build/SOCKS5Server.xcarchive \
            archive \
            CODE_SIGN_IDENTITY="-" \
            AD_HOC_CODE_SIGNING_ALLOWED=YES \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Create IPA
        run: |
          cd SOCKS5Server
          mkdir -p build/Payload
          cp -r build/SOCKS5Server.xcarchive/Products/Applications/SOCKS5Server.app build/Payload/
          cd build
          zip -r ../SOCKS5Server_v${{ env.APP_VERSION }}_${{ env.BUILD_NUMBER }}.ipa Payload
          cd ..
          mv SOCKS5Server_v${{ env.APP_VERSION }}_${{ env.BUILD_NUMBER }}.ipa ${{ github.workspace }}/

      - name: Upload IPA as Public Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SOCKS5Server_v${{ env.APP_VERSION }}_PR-${{ env.PR_NUMBER }}
          path: SOCKS5Server_v${{ env.APP_VERSION }}_${{ env.BUILD_NUMBER }}.ipa
          retention-days: 30

      - name: Add PR Comment with Build Success
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const appVersion = process.env.APP_VERSION;
            const buildNumber = process.env.BUILD_NUMBER;
            
            const comment = `### ‚úÖ Build Successful!
            
            The iOS app has been built successfully from this PR.
            
            **Build Details:**
            - Version: \`${appVersion}\`
            - Build: \`${buildNumber}\`
            - Artifact: \`SOCKS5Server_v${appVersion}_${buildNumber}.ipa\`
            
            **üì¶ Download the IPA:**
            The built IPA is available as a public artifact. Scroll down to the "Artifacts" section on this workflow run to download it.
            
            Direct link: [View Workflow Run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            
            > **Note:** You must be signed in to GitHub to download artifacts.`;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });

      - name: Job Summary - Build Complete
        run: |
          echo '### üõ†Ô∏è PR Build Complete!' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '**Build Details:**' >> $GITHUB_STEP_SUMMARY
          echo '- Version: `${{ env.APP_VERSION }}`' >> $GITHUB_STEP_SUMMARY
          echo '- Build: `${{ env.BUILD_NUMBER }}`' >> $GITHUB_STEP_SUMMARY
          echo '- PR: #${{ env.PR_NUMBER }}' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '### üì¶ Artifact Upload' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo 'The IPA has been uploaded as a public artifact. Scroll down to the [Artifacts](#artifacts) section to download it.' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '> **Note:** You must be signed in to GitHub to download artifacts.' >> $GITHUB_STEP_SUMMARY

  build-failure:
    name: Handle Build Failure
    runs-on: ubuntu-latest
    needs: build
    if: failure()
    permissions:
      pull-requests: write

    steps:
      - name: Add PR Comment on Build Failure
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            
            const comment = `### ‚ùå Build Failed
            
            The iOS app build failed for this PR. Please review the workflow logs to see what went wrong.
            
            [View Workflow Run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            
            Common issues:
            - Xcode build errors
            - Missing or invalid icon assets
            - Invalid Info.plist configuration
            - Code signing issues (though this is disabled for PR builds)`;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });
