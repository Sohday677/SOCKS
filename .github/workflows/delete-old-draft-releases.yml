name: Delete Old Draft Releases

on:
  workflow_dispatch:
    inputs:
      keep_count:
        description: "Number of draft releases to keep"
        default: "5"
        required: true
        type: string

jobs:
  delete-old-drafts:
    name: Delete Old Draft Releases
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Delete Old Draft Releases
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            const draftReleases = releases.filter(r => r.draft);
            const keepCount = parseInt('${{ inputs.keep_count }}', 10);
            
            if (draftReleases.length <= keepCount) {
              console.log(`Only ${draftReleases.length} draft releases exist. Nothing to delete.`);
              return;
            }
            
            // Sort by creation date (newest first)
            draftReleases.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            // Delete older drafts
            const toDelete = draftReleases.slice(keepCount);
            
            for (const release of toDelete) {
              console.log(`Deleting draft release: ${release.name} (${release.tag_name})`);
              await github.rest.repos.deleteRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release.id
              });
              
              // Also delete the tag if it exists
              try {
                await github.rest.git.deleteRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `tags/${release.tag_name}`
                });
                console.log(`Deleted tag: ${release.tag_name}`);
              } catch (e) {
                console.log(`Tag ${release.tag_name} may not exist or already deleted`);
              }
            }
            
            console.log(`Deleted ${toDelete.length} old draft releases.`);

      - name: Job Summary
        run: |
          echo -e '### ðŸ§¹ Cleanup Complete\n\nOld draft releases have been deleted. Only the most recent ${{ inputs.keep_count }} draft releases are kept.' >> $GITHUB_STEP_SUMMARY
